import"./styles-BufaHF3D.js";const D=[{slug:"youngsoo",label:"영수",desc:"계획형·현실감각",gender:"male"},{slug:"youngho",label:"영호",desc:"부드러운 리더형",gender:"male"},{slug:"youngsik",label:"영식",desc:"센스·눈치 빠름",gender:"male"},{slug:"youngchul",label:"영철",desc:"직진·추진형",gender:"male"},{slug:"kwangsoo",label:"광수",desc:"개성·집중형",gender:"male"},{slug:"sangchul",label:"상철",desc:"안정·책임형",gender:"male"},{slug:"oksoon",label:"옥순",desc:"존재감·자신감형",gender:"female"},{slug:"youngsook",label:"영숙",desc:"배려·균형형",gender:"female"},{slug:"soonja",label:"순자",desc:"담백·차분형",gender:"female"},{slug:"youngja",label:"영자",desc:"솔직·쿨형",gender:"female"},{slug:"jungsook",label:"정숙",desc:"신중·정리형",gender:"female"},{slug:"hyunsook",label:"현숙",desc:"밝음·사교형",gender:"female"}];function j(t){const e=Math.max(...t),o=t.map(n=>Math.exp(n-e)),a=o.reduce((n,s)=>n+s,0);return o.map(n=>n/a)}const G=D.map((t,e)=>[Math.sin(e+1)*.8,Math.cos(e+2)*.7,Math.sin(e+3)*.6,Math.cos(e+4)*.5,Math.sin(e+5)*.4,Math.cos(e+6)*.3,Math.sin(e+7)*.2,Math.cos(e+8)*.1]),E=D.map((t,e)=>[Math.sin(e*.61),Math.cos(e*.73),Math.sin(e*.47),Math.cos(e*.59),Math.sin(e*.31),Math.cos(e*.43),Math.sin(e*.23),Math.cos(e*.17)]);function I(t,e){let o=0;for(let a=0;a<8;a++)o+=(t[a]??0)*(e[a]??0);return o}function _(t){const e=t.reduce((n,s)=>n+s,0)/t.length,o=t.reduce((n,s)=>n+(s-e)**2,0)/t.length,a=Math.sqrt(o)||1;return t.map(n=>(n-e)/a)}function B(t,e=.75,o=.25){const a=_(t);return G.map((n,s)=>e*I(n,a)+o*I(E[s],a))}function O(t,e){return new Set(["oksoon","hyunsook","youngja","youngho","youngsik","youngchul"]).has(t)?.01:e==="male"?.09:0}function N(t,e){const o=t.map(c=>({...c,p:Math.max(0,c.p+O(c.slug,e))})),a=o.reduce((c,l)=>c+l.p,0)||1,n=o.map(c=>({...c,p:c.p/a})),s=.18,d=1/n.length;return n.map(c=>({...c,p:(1-s)*c.p+s*d}))}function H(t,e){const o=j(B(t)),a=D.map((n,s)=>({...n,p:o[s]})).filter(n=>n.gender===e);return N(a,e).sort((n,s)=>s.p-n.p).slice(0,3)}function V(t){const e=t.data;let o=0,a=0,n=0,s=0,d=0;const c=e.length/4,l=t.width;for(let u=0;u<e.length;u+=4){const w=e[u],b=e[u+1],S=e[u+2],p=.299*w+.587*b+.114*S,k=Math.max(w,b,S),P=Math.min(w,b,S);o+=p,d+=k===0?0:(k-P)/k,u/4%l<l/2?n+=p:s+=p,u>4&&(a+=Math.abs(p-(.299*e[u-4]+.587*e[u-3]+.114*e[u-2])))}o/=c,n/=c/2,s/=c/2,d/=c;const h=Math.abs(n-s)/255;return[o/255,(n-s)/255,a/(c*255),(n+s)/510,d,h,Math.sin(a/100),Math.cos(o/50)]}const U=document.querySelector("#upload"),T=document.querySelector("#genderValue"),g=Array.from(document.querySelectorAll("[data-gender-btn]")),i=document.querySelector("#preview"),f=document.querySelector("#analyze"),m=document.querySelector("#status"),M=i.getContext("2d",{willReadFrequently:!0});let y=!1;const F=new URLSearchParams(location.search).get("lang")||"ko",z={ko:{heroTitle:"사진 업로드 분석",heroDesc:"재미용 분류입니다. 이미지는 서버로 전송되지 않습니다.",genderLabel:"성별 선택(추천 타입 필터)",female:"여자",male:"남자",tip:"TIP: 얼굴이 정면에 크게 보일수록 결과가 안정적입니다.",back:"허브로 돌아가기",uploadGuide:"사진을 업로드해 주세요.",uploadDone:"사진 업로드 완료 (얼굴 중심 정렬)",uploadDoneSimple:"사진 업로드 완료",needUpload:"먼저 사진을 업로드해 주세요.",noFace:"얼굴이 감지되지 않았어요. 얼굴이 선명한 사진으로 다시 시도해 주세요.",analyzing:"분석 중...",analyze:"분석하기"},en:{heroTitle:"Photo Upload Analysis",heroDesc:"For fun only. Images are processed in-browser and not sent to server.",genderLabel:"Select Gender (recommended filter)",female:"Female",male:"Male",tip:"TIP: Results are better when your face is centered and clear.",back:"Back to Hub",uploadGuide:"Please upload a photo.",uploadDone:"Upload complete (face-centered).",uploadDoneSimple:"Upload complete.",needUpload:"Please upload a photo first.",noFace:"No face detected. Please try another photo with a clear face.",analyzing:"Analyzing...",analyze:"Analyze"},ja:{heroTitle:"写真アップロード分析",heroDesc:"お楽しみ用途です。画像はブラウザ内で処理され、サーバー送信されません。",genderLabel:"性別選択（推奨フィルター）",female:"女性",male:"男性",tip:"TIP: 顔が正面で大きく写るほど結果が安定します。",back:"ハブに戻る",uploadGuide:"写真をアップロードしてください。",uploadDone:"アップロード完了（顔中心に調整）",uploadDoneSimple:"アップロード完了",needUpload:"先に写真をアップロードしてください。",noFace:"顔が検出されませんでした。顔がはっきり見える写真で再試行してください。",analyzing:"分析中...",analyze:"分析する"}},r=z[F]||z.ko;m.textContent=r.uploadGuide;f.textContent=r.analyze;const L=document.querySelector(".hero h1"),R=document.querySelector(".hero p"),q=document.querySelector("section.card.stack label"),v=document.querySelector("section.card.stack small"),C=document.querySelector("a.btn.ghost[href='/']");L&&(L.textContent=r.heroTitle);R&&(R.textContent=r.heroDesc);q&&(q.textContent=r.genderLabel);g[0]&&(g[0].textContent=r.female);g[1]&&(g[1].textContent=r.male);v&&(v.textContent=r.tip);C&&(C.textContent=r.back,C.href=`/enjoy/?lang=${encodeURIComponent(F)}`);function $(t){const o=t.map(l=>Math.pow(Math.max(l.p,1e-6),1.3888888888888888)),a=o.reduce((l,h)=>l+h,0)||1,s=o.map(l=>l/a*100).map(l=>Math.round(l*10)/10),d=s.reduce((l,h)=>l+h,0),c=Math.round((100-d)*10)/10;return s[0]=Math.max(0,Math.round((s[0]+c)*10)/10),t.map((l,h)=>({...l,p:s[h]}))}function A(t){T.value=t,g.forEach(e=>{const o=e.dataset.gender===t;e.classList.toggle("active",o),e.classList.toggle("secondary",o)})}g.forEach(t=>{t.onclick=()=>A(t.dataset.gender||"female")});A("female");function x(t){const e=Math.min(t.width,t.height),o=(t.width-e)/2,a=(t.height-e)/2;M.clearRect(0,0,i.width,i.height),M.drawImage(t,o,a,e,e,0,0,i.width,i.height)}function J(t,e){const o=e.width*e.height,n=t.width*t.height/Math.max(1,o),s=Math.min(t.width,t.height),d=t.width/Math.max(1,t.height);return!(n<.03||s<90||d<.55||d>1.8)}async function W(t){const e=window.FaceDetector;if(!e)return x(t),"unsupported";const a=await new e({fastMode:!0,maxDetectedFaces:1}).detect(t);if(!a?.length)return x(t),!1;const n=a[0].boundingBox;if(!J(n,t))return x(t),!1;const s=.35,d=n.x+n.width/2,c=n.y+n.height/2,l=Math.max(n.width,n.height)*(1+s*2),h=Math.max(0,Math.min(t.width-l,d-l/2)),u=Math.max(0,Math.min(t.height-l,c-l/2));return M.clearRect(0,0,i.width,i.height),M.drawImage(t,h,u,l,l,0,0,i.width,i.height),!0}U.onchange=async()=>{const t=U.files?.[0];if(!t)return;const e=URL.createObjectURL(t),o=new Image;o.onload=async()=>{try{const a=await W(o);a===!1?(y=!1,m.textContent=r.noFace):(y=!0,m.textContent=a===!0?r.uploadDone:r.uploadDoneSimple)}catch{x(o),y=!0,m.textContent=r.uploadDoneSimple}finally{URL.revokeObjectURL(e)}},o.src=e};f.onclick=()=>{if(!y){m.textContent=r.needUpload;return}f.disabled=!0,m.textContent=r.analyzing;const t=T.value||"female",e=224,o=224,a=document.createElement("canvas");a.width=e,a.height=o,a.getContext("2d").drawImage(i,0,0,e,o);const n=a.getContext("2d").getImageData(0,0,e,o),s=V(n),d=H(s,t),c=$(d);sessionStorage.setItem("nsolo_result",JSON.stringify(c)),sessionStorage.setItem("nsolo_gender",t),sessionStorage.setItem("nsolo_face",i.toDataURL("image/jpeg",.9)),f.disabled=!1,window.location.href=`/result.html?lang=${encodeURIComponent(F)}`};
