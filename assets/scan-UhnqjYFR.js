import"./styles-BufaHF3D.js";const D=[{slug:"youngsoo",label:"영수",desc:"계획형·현실감각",gender:"male"},{slug:"youngho",label:"영호",desc:"부드러운 리더형",gender:"male"},{slug:"youngsik",label:"영식",desc:"센스·눈치 빠름",gender:"male"},{slug:"youngchul",label:"영철",desc:"직진·추진형",gender:"male"},{slug:"kwangsoo",label:"광수",desc:"개성·집중형",gender:"male"},{slug:"sangchul",label:"상철",desc:"안정·책임형",gender:"male"},{slug:"oksoon",label:"옥순",desc:"존재감·자신감형",gender:"female"},{slug:"youngsook",label:"영숙",desc:"배려·균형형",gender:"female"},{slug:"soonja",label:"순자",desc:"담백·차분형",gender:"female"},{slug:"youngja",label:"영자",desc:"솔직·쿨형",gender:"female"},{slug:"jungsook",label:"정숙",desc:"신중·정리형",gender:"female"},{slug:"hyunsook",label:"현숙",desc:"밝음·사교형",gender:"female"}];function A(t){const e=Math.max(...t),n=t.map(o=>Math.exp(o-e)),a=n.reduce((o,s)=>o+s,0);return n.map(o=>o/a)}const G=D.map((t,e)=>[Math.sin(e+1)*.8,Math.cos(e+2)*.7,Math.sin(e+3)*.6,Math.cos(e+4)*.5,Math.sin(e+5)*.4,Math.cos(e+6)*.3,Math.sin(e+7)*.2,Math.cos(e+8)*.1]),E=D.map((t,e)=>[Math.sin(e*.61),Math.cos(e*.73),Math.sin(e*.47),Math.cos(e*.59),Math.sin(e*.31),Math.cos(e*.43),Math.sin(e*.23),Math.cos(e*.17)]);function U(t,e){let n=0;for(let a=0;a<8;a++)n+=(t[a]??0)*(e[a]??0);return n}function O(t){const e=t.reduce((o,s)=>o+s,0)/t.length,n=t.reduce((o,s)=>o+(s-e)**2,0)/t.length,a=Math.sqrt(n)||1;return t.map(o=>(o-e)/a)}function _(t,e=.75,n=.25){const a=O(t);return G.map((o,s)=>e*U(o,a)+n*U(E[s],a))}function B(t,e){return new Set(["oksoon","hyunsook","youngja","youngho","youngsik","youngchul"]).has(t)?.01:e==="male"?.09:0}function N(t,e){const n=t.map(c=>({...c,p:Math.max(0,c.p+B(c.slug,e))})),a=n.reduce((c,l)=>c+l.p,0)||1,o=n.map(c=>({...c,p:c.p/a})),s=.18,u=1/o.length;return o.map(c=>({...c,p:(1-s)*c.p+s*u}))}function H(t,e){const n=A(_(t)),a=D.map((o,s)=>({...o,p:n[s]})).filter(o=>o.gender===e);return N(a,e).sort((o,s)=>s.p-o.p).slice(0,3)}function V(t){const e=t.data;let n=0,a=0,o=0,s=0,u=0;const c=e.length/4,l=t.width;for(let d=0;d<e.length;d+=4){const b=e[d],M=e[d+1],x=e[d+2],p=.299*b+.587*M+.114*x,w=Math.max(b,M,x),j=Math.min(b,M,x);n+=p,u+=w===0?0:(w-j)/w,d/4%l<l/2?o+=p:s+=p,d>4&&(a+=Math.abs(p-(.299*e[d-4]+.587*e[d-3]+.114*e[d-2])))}n/=c,o/=c/2,s/=c/2,u/=c;const h=Math.abs(o-s)/255;return[n/255,(o-s)/255,a/(c*255),(o+s)/510,u,h,Math.sin(a/100),Math.cos(n/50)]}const z=document.querySelector("#upload"),R=document.querySelector("#genderValue"),m=Array.from(document.querySelectorAll("[data-gender-btn]")),i=document.querySelector("#preview"),f=document.querySelector("#analyze"),g=document.querySelector("#status"),y=i.getContext("2d",{willReadFrequently:!0});let k=!1;const I=new URLSearchParams(location.search).get("lang")||"ko",q={ko:{heroTitle:"사진 업로드 분석",heroDesc:"재미용 분류입니다. 이미지는 서버로 전송되지 않습니다.",genderLabel:"성별 선택(추천 타입 필터)",female:"여자",male:"남자",tip:"TIP: 얼굴이 정면에 크게 보일수록 결과가 안정적입니다.",back:"허브로 돌아가기",uploadGuide:"사진을 업로드해 주세요.",uploadDone:"사진 업로드 완료 (얼굴 중심 정렬)",uploadDoneSimple:"사진 업로드 완료",needUpload:"먼저 사진을 업로드해 주세요.",analyzing:"분석 중...",analyze:"분석하기"},en:{heroTitle:"Photo Upload Analysis",heroDesc:"For fun only. Images are processed in-browser and not sent to server.",genderLabel:"Select Gender (recommended filter)",female:"Female",male:"Male",tip:"TIP: Results are better when your face is centered and clear.",back:"Back to Hub",uploadGuide:"Please upload a photo.",uploadDone:"Upload complete (face-centered).",uploadDoneSimple:"Upload complete.",needUpload:"Please upload a photo first.",analyzing:"Analyzing...",analyze:"Analyze"},ja:{heroTitle:"写真アップロード分析",heroDesc:"お楽しみ用途です。画像はブラウザ内で処理され、サーバー送信されません。",genderLabel:"性別選択（推奨フィルター）",female:"女性",male:"男性",tip:"TIP: 顔が正面で大きく写るほど結果が安定します。",back:"ハブに戻る",uploadGuide:"写真をアップロードしてください。",uploadDone:"アップロード完了（顔中心に調整）",uploadDoneSimple:"アップロード完了",needUpload:"先に写真をアップロードしてください。",analyzing:"分析中...",analyze:"分析する"}},r=q[I]||q.ko;g.textContent=r.uploadGuide;f.textContent=r.analyze;const v=document.querySelector(".hero h1"),F=document.querySelector(".hero p"),T=document.querySelector("section.card.stack label"),L=document.querySelector("section.card.stack small"),S=document.querySelector("a.btn.ghost[href='/']");v&&(v.textContent=r.heroTitle);F&&(F.textContent=r.heroDesc);T&&(T.textContent=r.genderLabel);m[0]&&(m[0].textContent=r.female);m[1]&&(m[1].textContent=r.male);L&&(L.textContent=r.tip);S&&(S.textContent=r.back,S.href=`/enjoy/?lang=${encodeURIComponent(I)}`);function $(t){const n=t.map(l=>Math.pow(Math.max(l.p,1e-6),1.3888888888888888)),a=n.reduce((l,h)=>l+h,0)||1,s=n.map(l=>l/a*100).map(l=>Math.round(l*10)/10),u=s.reduce((l,h)=>l+h,0),c=Math.round((100-u)*10)/10;return s[0]=Math.max(0,Math.round((s[0]+c)*10)/10),t.map((l,h)=>({...l,p:s[h]}))}function P(t){R.value=t,m.forEach(e=>{const n=e.dataset.gender===t;e.classList.toggle("active",n),e.classList.toggle("secondary",n)})}m.forEach(t=>{t.onclick=()=>P(t.dataset.gender||"female")});P("female");function C(t){const e=Math.min(t.width,t.height),n=(t.width-e)/2,a=(t.height-e)/2;y.clearRect(0,0,i.width,i.height),y.drawImage(t,n,a,e,e,0,0,i.width,i.height)}async function J(t){const e=window.FaceDetector;if(!e)return C(t);const a=await new e({fastMode:!0,maxDetectedFaces:1}).detect(t);if(!a?.length)return C(t);const o=a[0].boundingBox,s=.35,u=o.x+o.width/2,c=o.y+o.height/2,l=Math.max(o.width,o.height)*(1+s*2),h=Math.max(0,Math.min(t.width-l,u-l/2)),d=Math.max(0,Math.min(t.height-l,c-l/2));y.clearRect(0,0,i.width,i.height),y.drawImage(t,h,d,l,l,0,0,i.width,i.height)}z.onchange=async()=>{const t=z.files?.[0];if(!t)return;const e=URL.createObjectURL(t),n=new Image;n.onload=async()=>{try{await J(n),k=!0,g.textContent=r.uploadDone}catch{C(n),k=!0,g.textContent=r.uploadDoneSimple}finally{URL.revokeObjectURL(e)}},n.src=e};f.onclick=()=>{if(!k){g.textContent=r.needUpload;return}f.disabled=!0,g.textContent=r.analyzing;const t=R.value||"female",e=224,n=224,a=document.createElement("canvas");a.width=e,a.height=n,a.getContext("2d").drawImage(i,0,0,e,n);const o=a.getContext("2d").getImageData(0,0,e,n),s=V(o),u=H(s,t),c=$(u);sessionStorage.setItem("nsolo_result",JSON.stringify(c)),sessionStorage.setItem("nsolo_gender",t),f.disabled=!1,window.location.href=`/result.html?lang=${encodeURIComponent(I)}`};
